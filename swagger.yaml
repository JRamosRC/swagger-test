openapi: 3.0.3
info:
  title: Barreras API
  version: 1.0.0
  description: |
    API de integración de barreras (collection "Barreras" exportada desde Postman).
    Este esquema fue generado a partir de las requests existentes en Postman y
    está pensado como base para documentar la API en Swagger UI.

servers:
  - url: https://{baseURL}
    description: Servidor principal de la API de barreras
    variables:
      baseURL:
        default: parquimetro-staging.herokuapp.com
        description: Host base de la API (sin `/api`).

components:
  securitySchemes:
    ApiKeyAuth:
      type: apiKey
      in: header
      name: API-KEY
      description: API key de autenticación.
    BarrierTokenAuth:
      type: apiKey
      in: header
      name: token
      description: Token de sesión de la barrera.

  schemas:
    LoginResponse:
      type: object
      description: Respuesta de login de barrera.
      properties:
        access_token:
          type: string
        token_type:
          type: string
          nullable: true
        expires_in:
          type: integer
          format: int32
          nullable: true
    PaymentResponse:
      type: object
      description: Respuesta genérica de operaciones de pago.
      properties:
        payment_id:
          type: string
    CashStatus:
      type: object
      properties:
        name:
          type: string
        level_recycler:
          type: string
        level_casete:
          type: string
        deposit_level:
          type: string
        cash_type:
          type: string
          description: Tipo de efectivo (coin, bill, etc.)
        value:
          type: string
    ServiceItem:
      type: object
      properties:
        quantity:
          type: integer
        service_category_id:
          type: integer

paths:
  /api/barreras/ingresar:
    post:
      tags: [Autenticación]
      summary: Login de barrera
      description: Inicia sesión de la barrera y obtiene un token de acceso (`barrierToken`).
      security:
        - ApiKeyAuth: []
      requestBody:
        required: true
        content:
          application/x-www-form-urlencoded:
            schema:
              type: object
              required:
                - serial_number
                - app_version
              properties:
                serial_number:
                  type: string
                  description: Número de serie de la barrera.
                app_version:
                  type: string
                  description: Versión de la aplicación de la barrera.
      responses:
        '200':
          description: Login exitoso.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/LoginResponse'

  /api/barreras/estado:
    post:
      tags: [Estado]
      summary: Reportar estado de la barrera
      description: Envía el estado de la barrera (keep-alive, conexión, etc.).
      security:
        - ApiKeyAuth: []
          BarrierTokenAuth: []
      requestBody:
        required: true
        content:
          application/x-www-form-urlencoded:
            schema:
              type: object
              required:
                - status_type
                - status
              properties:
                status_type:
                  type: string
                  example: connection_status
                status:
                  type: string
                  example: ok
                description:
                  type: string
                  example: Keep Alive
                barrier_timestamp:
                  type: string
                  description: Fecha y hora reportada por la barrera.
      responses:
        '200':
          description: Estado recibido correctamente.

  /api/barreras/pago_especial:
    post:
      tags: [Pagos]
      summary: Pago especial
      description: |
        Crea o actualiza un pago especial asociado a una transacción.
        (En Postman se usa como "Inicio Pago" y "Terminar Pago".)
      security:
        - ApiKeyAuth: []
          BarrierTokenAuth: []
      requestBody:
        required: true
        content:
          application/x-www-form-urlencoded:
            schema:
              type: object
              required:
                - transaction_id
              properties:
                transaction_id:
                  type: string
                  description: ID de la transacción asociada.
                coupon:
                  type: string
                  nullable: true
                  description: Código de cupón (opcional).
      responses:
        '200':
          description: Operación de pago especial procesada.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PaymentResponse'

  /api/barreras/ingreso_rapido:
    post:
      tags: [Ingresos]
      summary: Ingreso rápido por patente
      description: Crea una transacción de ingreso rápido usando la patente.
      security:
        - ApiKeyAuth: []
          BarrierTokenAuth: []
      requestBody:
        required: true
        content:
          application/x-www-form-urlencoded:
            schema:
              type: object
              required:
                - license_plate
              properties:
                license_plate:
                  type: string
                  example: HH-HH-66
                entry_date:
                  type: string
                  nullable: true
                  description: Fecha de entrada (opcional).
      responses:
        '200':
          description: Ingreso registrado correctamente.

  /api/barreras/check_rfid:
    post:
      tags: [Ingresos]
      summary: Check-in por RFID
      description: Valida un RFID y registra ingreso si corresponde.
      security:
        - ApiKeyAuth: []
          BarrierTokenAuth: []
      requestBody:
        required: true
        content:
          application/x-www-form-urlencoded:
            schema:
              type: object
              required:
                - rfid_serial
              properties:
                rfid_serial:
                  type: string
                  example: "286240"
                entry_date:
                  type: string
                  nullable: true
      responses:
        '200':
          description: RFID procesado.

  /api/barreras/ingreso_reserva:
    post:
      tags: [Ingresos]
      summary: Ingreso por reserva
      description: Registra el ingreso usando un ID de reserva.
      security:
        - ApiKeyAuth: []
          BarrierTokenAuth: []
      requestBody:
        required: true
        content:
          application/x-www-form-urlencoded:
            schema:
              type: object
              required:
                - reservation_id
              properties:
                reservation_id:
                  type: string
                  example: "1206"
                entry_date:
                  type: string
                  nullable: true
      responses:
        '200':
          description: Ingreso por reserva registrado.

  /api/barreras/paybox/pagos:
    post:
      tags: [Paybox]
      summary: Pago en Paybox
      description: Registra un pago realizado en un Paybox.
      security:
        - ApiKeyAuth: []
          BarrierTokenAuth: []
      requestBody:
        required: true
        content:
          application/x-www-form-urlencoded:
            schema:
              type: object
              required:
                - payment_method
                - amount
                - transbank_voucher
                - payment_date
              properties:
                payment_method:
                  type: string
                  example: card
                amount:
                  type: string
                  example: "200"
                transbank_voucher:
                  type: string
                  example: "1234"
                payment_date:
                  type: string
                  example: "15-4-2025 13:09"
      responses:
        '200':
          description: Pago registrado.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PaymentResponse'

  /api/barreras/terminar_salida:
    post:
      tags: [Salidas]
      summary: Terminar salida
      description: Finaliza la salida de una transacción ya pagada.
      security:
        - ApiKeyAuth: []
          BarrierTokenAuth: []
      requestBody:
        required: true
        content:
          application/x-www-form-urlencoded:
            schema:
              type: object
              required:
                - transaction_id
              properties:
                transaction_id:
                  type: string
                  description: ID de la transacción asociada.
                cash_change:
                  type: string
                  nullable: true
                payment_id:
                  type: string
                  nullable: true
                payment_date:
                  type: string
                  nullable: true
      responses:
        '200':
          description: Salida finalizada correctamente.

  /api/barreras/estado/{transaction_id}:
    patch:
      tags: [Estado]
      summary: Actualizar estado de transacción
      description: Actualiza el estado de una transacción específica.
      security:
        - ApiKeyAuth: []
          BarrierTokenAuth: []
      parameters:
        - name: transaction_id
          in: path
          required: true
          schema:
            type: string
          description: ID de la transacción cuyo estado se actualiza.
      requestBody:
        required: true
        content:
          application/x-www-form-urlencoded:
            schema:
              type: object
              properties:
                cash_change:
                  type: string
                payment_id:
                  type: string
                payment_date:
                  type: string
                license_plate:
                  type: string
                  example: XD-XX-94
                offline_unique_id:
                  type: string
                  example: unidbkno6
                exit_date:
                  type: string
                  example: "7/2/2024"
      responses:
        '200':
          description: Estado actualizado.

  /api/barreras/estado_patente:
    put:
      tags: [Estado]
      summary: Actualizar estado por patente
      description: Actualiza el estado de una transacción asociada a una patente.
      security:
        - ApiKeyAuth: []
          BarrierTokenAuth: []
      requestBody:
        required: true
        content:
          application/x-www-form-urlencoded:
            schema:
              type: object
              required:
                - license_plate
              properties:
                transaction_id:
                  type: string
                  nullable: true
                license_plate:
                  type: string
                  example: XD-XD-11
      responses:
        '200':
          description: Estado de patente actualizado.

  /api/barreras/iniciar_reembolso:
    post:
      tags: [Reembolsos]
      summary: Iniciar reembolso
      description: Inicia el proceso de reembolso de un pago.
      security:
        - ApiKeyAuth: []
          BarrierTokenAuth: []
      requestBody:
        required: true
        content:
          application/x-www-form-urlencoded:
            schema:
              type: object
              required:
                - payment_id
              properties:
                payment_id:
                  type: string
                  description: ID del pago a reembolsar.
      responses:
        '200':
          description: Reembolso iniciado.

  /api/barreras/salida_patente:
    post:
      tags: [Salidas]
      summary: Registrar salida por patente
      description: Registra la salida de un vehículo por patente.
      security:
        - ApiKeyAuth: []
          BarrierTokenAuth: []
      requestBody:
        required: true
        content:
          application/x-www-form-urlencoded:
            schema:
              type: object
              required:
                - license_plate
              properties:
                license_plate:
                  type: string
                  example: XD-XX-94
      responses:
        '200':
          description: Salida registrada.

  /api/barreras/confirmar_reembolso:
    post:
      tags: [Reembolsos]
      summary: Confirmar reembolso
      description: Confirma un reembolso previamente iniciado.
      security:
        - ApiKeyAuth: []
          BarrierTokenAuth: []
      requestBody:
        required: true
        content:
          application/x-www-form-urlencoded:
            schema:
              type: object
              required:
                - payment_id
              properties:
                payment_id:
                  type: string
      responses:
        '200':
          description: Reembolso confirmado.

  /api/barreras/estado_cashdro:
    post:
      tags: [Cashdro]
      summary: Reportar estado de Cashdro
      description: Envía los estados de niveles de efectivo del equipo Cashdro.
      security:
        - ApiKeyAuth: []
          BarrierTokenAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                cash_statuses:
                  type: array
                  items:
                    $ref: '#/components/schemas/CashStatus'
      responses:
        '200':
          description: Estado de Cashdro recibido.

  /api/barreras/servicios_solicitados:
    post:
      tags: [Servicios]
      summary: Compra de servicios en tótem
      description: Registra servicios solicitados en el tótem.
      security:
        - ApiKeyAuth: []
          BarrierTokenAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                services:
                  type: array
                  items:
                    $ref: '#/components/schemas/ServiceItem'
      responses:
        '200':
          description: Servicios registrados.

  /api/barreras/servicios:
    get:
      tags: [Servicios]
      summary: Obtener servicios disponibles
      description: Devuelve la lista de servicios disponibles.
      security:
        - ApiKeyAuth: []
          BarrierTokenAuth: []
      responses:
        '200':
          description: Lista de servicios.

  /api/barreras/ingreso_patente:
    post:
      tags: [Ingresos]
      summary: Ingreso por patente (LPR)
      description: Registra ingreso usando patente detectada por LPR.
      security:
        - ApiKeyAuth: []
          BarrierTokenAuth: []
      requestBody:
        required: true
        content:
          application/x-www-form-urlencoded:
            schema:
              type: object
              required:
                - license_plate
                - lpr_unique_id
              properties:
                license_plate:
                  type: string
                  example: AA-AA-56
                lpr_unique_id:
                  type: string
                  example: "1122122"
      responses:
        '200':
          description: Ingreso registrado.

  /api/barreras/sucursal:
    get:
      tags: [Sucursal]
      summary: Obtener sucursal de la barrera
      description: Devuelve la sucursal asociada a la barrera.
      security:
        - ApiKeyAuth: []
          BarrierTokenAuth: []
      responses:
        '200':
          description: Información de la sucursal.
    post:
      tags: [Sucursal]
      summary: Operación sobre sucursal / liberados
      description: |
        Operaciones POST asociadas a la sucursal (en Postman se usa como "Liberados"
        y otras operaciones relacionadas).
      responses:
        '200':
          description: Operación procesada.

  /api/barreras/v2/pagos/{payment_id}/aplicar_descuento:
    post:
      tags: [Pagos]
      summary: Aplicar descuento a pago
      description: Aplica un descuento a un pago existente.
      parameters:
        - name: payment_id
          in: path
          required: true
          schema:
            type: string
          description: ID del pago al que se aplica el descuento.
      responses:
        '200':
          description: Descuento aplicado.

  /api/barreras/paybox/pagos/iniciar_pago:
    post:
      tags: [Paybox]
      summary: Iniciar pago en Paybox
      description: Inicia un pago en el Paybox.
      security:
        - ApiKeyAuth: []
          BarrierTokenAuth: []
      requestBody:
        required: true
        content:
          application/x-www-form-urlencoded:
            schema:
              type: object
              required:
                - payment_method
                - amount
              properties:
                payment_method:
                  type: string
                  example: cash
                amount:
                  type: string
                  example: "200"
                transbank_voucher:
                  type: string
                  nullable: true
                payment_date:
                  type: string
                  nullable: true
      responses:
        '200':
          description: Pago iniciado.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PaymentResponse'

  /api/barreras/paybox/pagos/actualizar_estado:
    post:
      tags: [Paybox]
      summary: Actualizar estado de pago en Paybox
      description: Actualiza el estado de un pago en Paybox.
      security:
        - ApiKeyAuth: []
          BarrierTokenAuth: []
      requestBody:
        required: true
        content:
          application/x-www-form-urlencoded:
            schema:
              type: object
              required:
                - payment_id
              properties:
                payment_method:
                  type: string
                  nullable: true
                amount:
                  type: string
                  nullable: true
                transbank_voucher:
                  type: string
                  example: "1234"
                payment_date:
                  type: string
                  nullable: true
                payment_id:
                  type: string
                  example: "93328"
                payment_status:
                  type: string
                  description: Estado del pago.
      responses:
        '200':
          description: Estado de pago actualizado.

  /api/barreras/paybox/pagos/finalizar_pago:
    post:
      tags: [Paybox]
      summary: Finalizar pago en Paybox
      description: Finaliza un pago en Paybox.
      security:
        - ApiKeyAuth: []
          BarrierTokenAuth: []
      requestBody:
        required: true
        content:
          application/x-www-form-urlencoded:
            schema:
              type: object
              required:
                - amount
                - transbank_voucher
              properties:
                payment_method:
                  type: string
                  nullable: true
                amount:
                  type: string
                  example: "200"
                transbank_voucher:
                  type: string
                  example: "1234"
                payment_date:
                  type: string
                  nullable: true
                id:
                  type: string
                  nullable: true
      responses:
        '200':
          description: Pago finalizado.

  /api/barreras/amipass/pago:
    post:
      tags: [Amipass]
      summary: Pago con Amipass
      description: Registra un pago usando Amipass.
      security:
        - ApiKeyAuth: []
          BarrierTokenAuth: []
      requestBody:
        required: true
        content:
          application/x-www-form-urlencoded:
            schema:
              type: object
              required:
                - client_qr_code
                - amount
              properties:
                client_qr_code:
                  type: string
                  example: "71060565"
                amount:
                  type: string
                  example: "100"
      responses:
        '200':
          description: Pago Amipass registrado.

  /api/barreras/amipass/anulacion:
    post:
      tags: [Amipass]
      summary: Anulación Amipass
      description: Anula un pago realizado con Amipass.
      security:
        - ApiKeyAuth: []
          BarrierTokenAuth: []
      requestBody:
        required: true
        content:
          application/x-www-form-urlencoded:
            schema:
              type: object
              required:
                - client_qr_code
              properties:
                client_qr_code:
                  type: string
                authorization_code:
                  type: string
                  nullable: true
                payment_id:
                  type: string
                  nullable: true
                amount:
                  type: string
                  nullable: true
      responses:
        '200':
          description: Pago Amipass anulado.
